<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BoatiesMate – Document Viewer</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; max-width: 820px; margin: 0 auto; }
    .topnav { display: flex; gap: 12px; margin-bottom: 14px; flex-wrap: wrap; }
    a { color: #0b57d0; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin: 12px 0; }
    .muted { color: #666; }
    .ok { color: #0a7a2f; font-weight: bold; }
    .bad { color: #b00020; font-weight: bold; }
    iframe { width: 100%; height: 75vh; border: 1px solid #ddd; border-radius: 10px; }
    code { background: #f5f5f5; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <div class="topnav">
    <a id="backReview" href="#">← Back to Operator Review</a>
    <a href="/operator-inbox.html">Back to Operator Inbox</a>
  </div>

  <h2>Compliance Document</h2>

  <div class="card">
    <div><strong>Doc key:</strong> <code id="docKey">—</code></div>
    <div><strong>Status:</strong> <span id="docStatus">—</span></div>
    <div><strong>Expires:</strong> <span id="docExpires">—</span></div>
    <div><strong>Vessel ID:</strong> <span id="vesselId">—</span></div>
    <div><strong>Booking ID:</strong> <span id="bookingId">—</span></div>
    <div style="margin-top:8px;"><strong>File:</strong> <code id="filePath">—</code></div>
    <div style="margin-top:10px;"><span id="statusLine" class="muted">Loading…</span></div>
  </div>

  <div id="viewerWrap" class="card" style="display:none;">
    <iframe id="pdfFrame" title="PDF viewer"></iframe>
  </div>

  <div id="missingWrap" class="card" style="display:none;">
    <div class="bad">Document not available</div>
    <p class="muted" style="margin-bottom:0;">
      This document is not present as a static PDF in the demo build yet.
      Phase 8 is read-only; uploads and enforcement are Phase 9.
    </p>
    <p class="muted" style="margin-top:10px; margin-bottom:0;">
      If this is expected (e.g., Shore Power Lead Test), the operator can still proceed with the rest of the Application Pack.
    </p>
  </div>

  <script>
    function qs(name) { return new URLSearchParams(window.location.search).get(name); }

    const doc = (qs("doc") || "").toLowerCase();
    const status = qs("status") || "";
    const expiresAt = qs("expiresAt") || "";
    const bookingId = qs("bookingId") || "";
    const vesselId = qs("vesselId") || "";

    const back = document.getElementById("backReview");
    back.href = bookingId ? `/operator-review.html?bookingId=${encodeURIComponent(bookingId)}` : "/operator-review.html";

    document.getElementById("docKey").textContent = doc || "—";
    document.getElementById("docStatus").textContent = status || "—";
    document.getElementById("docExpires").textContent = expiresAt || "—";
    document.getElementById("bookingId").textContent = bookingId || "—";
    document.getElementById("vesselId").textContent = vesselId || "—";

    const statusLine = document.getElementById("statusLine");
    const viewerWrap = document.getElementById("viewerWrap");
    const missingWrap = document.getElementById("missingWrap");
    const frame = document.getElementById("pdfFrame");

    // Map backend doc keys -> our static filename prefixes
    const DOC_PREFIX = {
      insurance: "insurance",
      ewof: "ewof",
      registration: "registration",
      boat_registration: "registration",
      rego: "registration",
      // Known-but-not-yet-provided PDFs (falls back)
      shore_power_lead_test: null
    };

    function buildFilePath(docKey, vesselId) {
      const prefix = Object.prototype.hasOwnProperty.call(DOC_PREFIX, docKey) ? DOC_PREFIX[docKey] : null;
      if (!prefix) return null;
      if (!vesselId) return null;
      return `/compliance-docs/${encodeURIComponent(prefix)}-vessel-${encodeURIComponent(vesselId)}.pdf`;
    }

    const file = buildFilePath(doc, vesselId);
    document.getElementById("filePath").textContent = file || "—";

    if (!file) {
      statusLine.textContent = "No static file mapped for this document type (fallback shown).";
      statusLine.className = "bad";
      missingWrap.style.display = "block";
    } else {
      fetch(file, { method: "HEAD" })
        .then((res) => {
          if (!res.ok) throw new Error(String(res.status));
          statusLine.textContent = "File found.";
          statusLine.className = "ok";
          viewerWrap.style.display = "block";
          frame.src = file;
        })
        .catch(() => {
          statusLine.textContent = "File missing (fallback shown).";
          statusLine.className = "bad";
          missingWrap.style.display = "block";
        });
    }
  </script>
</body>
</html>
